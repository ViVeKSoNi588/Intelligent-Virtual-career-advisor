{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Resume Analysis - Career Advisor{% endblock %}

{% block extra_css %}
<style>
    .keyword-pill {
        display: inline-block;
        padding: 0.35rem 0.65rem;
        margin: 0.25rem;
        border-radius: 50rem;
    }
    .keyword-present {
        background-color: rgba(25, 135, 84, 0.15);
        color: #75b798;
        border: 1px solid #75b798;
    }
    .keyword-missing {
        background-color: rgba(220, 53, 69, 0.15);
        color: #ea868f;
        border: 1px solid #ea868f;
    }
    .improvement-step {
        margin-bottom: 1rem;
        padding-left: 2rem;
        position: relative;
    }
    .improvement-step:before {
        content: counters(step, ".") "";
        counter-increment: step;
        position: absolute;
        left: 0;
        top: 0;
        width: 1.5rem;
        height: 1.5rem;
        line-height: 1.5rem;
        text-align: center;
        background-color: var(--bs-primary);
        color: white;
        border-radius: 50%;
        font-size: 0.8rem;
    }
    .improvement-plan {
        counter-reset: step;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Resume Analysis</h2>
            <p class="text-muted">
                Get personalized feedback and improvement suggestions for your resume. 
                Our AI analyzes your resume against industry standards and job requirements.
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Resume Analysis Form -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <h4 class="mb-3">Analyze Your Resume</h4>
            <p class="text-muted mb-4">
                Paste your resume text below or we'll use the one from your profile. 
                Provide a target job title to receive tailored feedback.
            </p>
            
            <form method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-9 mb-3">
                        {{ form.job_title|as_crispy_field }}
                    </div>
                    <div class="col-md-12 mb-3">
                        {{ form.resume_text|as_crispy_field }}
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i> Analyze Resume
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {% if analysis %}
    <!-- Analysis Results -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Analysis Results</h4>
        </div>
        <div class="card-body p-4">
            <div class="row mb-4">
                <div class="col-md-4 text-center">
                    <div class="position-relative d-inline-block">
                        <canvas id="resumeScoreChart" width="200" height="200"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle text-center">
                            <h2 class="mb-0">{{ analysis.strength_score }}</h2>
                            <p class="mb-0 text-muted">out of 10</p>
                        </div>
                    </div>
                    <h5 class="mt-3">Resume Strength
                        {% if analysis.strength_score >= 8 %}
                        <span class="badge bg-success">Strong</span>
                        {% elif analysis.strength_score >= 5 %}
                        <span class="badge bg-warning">Good</span>
                        {% else %}
                        <span class="badge bg-danger">Needs Work</span>
                        {% endif %}
                    </h5>
                    <p class="text-muted">Analyzed on {{ analysis.analyzed_at|date:"F j, Y" }}</p>
                </div>
                <div class="col-md-8">
                    <h5 class="mb-3">Areas for Improvement</h5>
                    <ul class="list-group list-group-flush mb-4">
                        {% for weakness in analysis.weaknesses %}
                        <li class="list-group-item bg-transparent d-flex">
                            <i class="fas fa-exclamation-circle text-warning me-2 mt-1"></i>
                            <span>{{ weakness }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item bg-transparent">No significant weaknesses found</li>
                        {% endfor %}
                    </ul>
                    
                    <h5 class="mb-3">Improvement Suggestions</h5>
                    <ul class="list-group list-group-flush">
                        {% for suggestion in analysis.suggestions %}
                        <li class="list-group-item bg-transparent d-flex">
                            <i class="fas fa-lightbulb text-primary me-2 mt-1"></i>
                            <span>{{ suggestion }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item bg-transparent">No suggestions available</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <hr>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5 class="mb-3">Keyword Analysis</h5>
                    <p class="text-muted">How your resume matches industry keywords</p>
                    
                    <h6 class="text-success mb-2">Present Keywords</h6>
                    <div>
                        {% for keyword in analysis.keyword_analysis.present %}
                        <span class="keyword-pill keyword-present">{{ keyword }}</span>
                        {% empty %}
                        <p class="text-muted">No matching keywords found</p>
                        {% endfor %}
                    </div>
                    
                    <h6 class="text-danger mt-3 mb-2">Missing Keywords</h6>
                    <div>
                        {% for keyword in analysis.keyword_analysis.missing %}
                        <span class="keyword-pill keyword-missing">{{ keyword }}</span>
                        {% empty %}
                        <p class="text-muted">No missing keywords identified</p>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5 class="mb-3">Improvement Plan</h5>
                    <p class="text-muted">Follow these steps to enhance your resume</p>
                    
                    <div class="improvement-plan">
                        <div class="improvement-step">
                            {{ analysis.improvement_plan|linebreaksbr }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Next Steps Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <h4 class="mb-3">Next Steps</h4>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-pencil-alt fa-3x mb-3 text-primary"></i>
                            <h5>Update Your Resume</h5>
                            <p class="text-muted">Apply the suggestions to improve your resume.</p>
                            <a href="{% url 'profile' %}" class="btn btn-outline-primary">Edit Profile</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-comments fa-3x mb-3 text-primary"></i>
                            <h5>Interview Preparation</h5>
                            <p class="text-muted">Prepare for interviews with our guidance.</p>
                            <a href="{% url 'interview_prep' %}" class="btn btn-outline-primary">Get Started</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-route fa-3x mb-3 text-primary"></i>
                            <h5>Explore Career Paths</h5>
                            <p class="text-muted">Discover potential career opportunities.</p>
                            <a href="{% url 'career_paths' %}" class="btn btn-outline-primary">Explore</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/charts.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if analysis %}
        // Create resume score doughnut chart
        createResumeScoreChart('resumeScoreChart', {{ analysis.strength_score }});
        
        // Parse improvement plan steps and format them
        const improvementPlan = document.querySelector('.improvement-plan');
        if (improvementPlan) {
            const planText = `{{ analysis.improvement_plan|safe }}`;
            const steps = planText.split('\n').filter(step => step.trim().length > 0);
            
            improvementPlan.innerHTML = '';
            steps.forEach(step => {
                // Extract step number and content
                const match = step.match(/^\d+\.\s*(.*)/);
                if (match) {
                    const content = match[1];
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'improvement-step';
                    stepDiv.textContent = content;
                    improvementPlan.appendChild(stepDiv);
                }
            });
        }
        {% endif %}
    });
</script>
{% endblock %}
